# SmartHeart Bot

Надежный и гибкий Telegram-бот для публикации контента и отслеживания действий пользователей. Бот служит платформой для распространения контента креативного агентства, обеспечивая удобную публикацию материалов, отслеживание активности пользователей и управление автоматическими рассылками.

## Обзор проекта

SmartHeart Bot предоставляет комплексное решение для:
- **Публикации контента**: Управление и распространение материалов, продуктов и событий среди пользователей
- **Отслеживания активности**: Мониторинг взаимодействий пользователей, просмотров материалов и заполнения профилей
- **Автоматических рассылок**: Планирование и отправка целевых сообщений пользователям
- **Интеграции с CRM**: Синхронизация данных пользователей с AmoCRM для управления лидами
- **Админ-панели**: Полный административный контроль через интерфейс Telegram

## Архитектура

Проект следует чистой модульной структуре:

```
SmartHeart/
├── app/
│   ├── bot/
│   │   ├── admin_handlers/      # Обработчики команд и колбэков для админов
│   │   ├── user_handlers/       # Обработчики команд и колбэков для пользователей
│   │   ├── services/            # Слой бизнес-логики
│   │   │   ├── amocrm_service.py
│   │   │   ├── file_service.py
│   │   │   ├── mailing_service.py
│   │   │   ├── material_service.py
│   │   │   └── user_service.py
│   │   ├── messages.py          # Централизованные шаблоны сообщений
│   │   ├── scheduler.py         # Планировщик рассылок
│   │   ├── mailing_sender.py    # Логика выполнения рассылок
│   │   ├── utils.py             # Вспомогательные функции
│   │   └── validators.py        # Валидация входных данных
│   ├── db/
│   │   ├── models.py            # SQLAlchemy модели
│   │   └── database.py          # Подключение к БД и управление сессиями
│   └── config.py                # Конфигурация и переменные окружения
├── main.py                       # Точка входа приложения
└── requirements.txt              # Зависимости Python
```

## Основные возможности

### Управление контентом
- **Материалы**: Категоризация и публикация обучающих материалов с поддержкой медиа
- **Управление файлами**: Хранение и получение файлов (документы, изображения, видео)
- **Отслеживание просмотров**: Запись и анализ взаимодействий пользователей с материалами

### Управление пользователями
- **Система профилей**: Сбор и управление профилями пользователей (имя, компания, должность, телефон)
- **Управление согласиями**: Отслеживание согласия пользователей на обработку данных
- **Статистика пользователей**: Экспорт данных пользователей с историей просмотров материалов

### Система рассылок
- **Запланированные рассылки**: Планирование и отложенная отправка сообщений
- **Отслеживание прогресса**: Мониторинг прогресса рассылки в реальном времени
- **Множественные форматы**: Поддержка текстовых, фото и видео сообщений
- **Обработка ошибок**: Автоматическое отслеживание заблокированных пользователей и ошибок доставки

### Интеграция с CRM
- **Синхронизация с AmoCRM**: Создание лидов и синхронизация данных пользователей с AmoCRM
- **Управление лидами**: Связывание пользователей Telegram с лидами в CRM

## Модели базы данных

- **User**: Хранит профили пользователей, статус согласия и ID лидов в CRM
- **Material**: Элементы контента с категориями, медиа и вложениями документов
- **UserMaterialView**: Отслеживает, какие материалы просмотрели пользователи
- **File**: Управляет загруженными файлами и их Telegram file ID
- **Mailing**: Хранит кампании рассылок с планированием и статистикой

## Технологический стек

- **Python 3.10+**
- **pyTelegramBotAPI**: Обертка для Telegram Bot API
- **SQLAlchemy 2.0**: ORM для работы с базой данных
- **Loguru**: Фреймворк для логирования
- **python-dotenv**: Управление переменными окружения
- **openpyxl**: Генерация Excel файлов для экспорта статистики

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Создайте файл `.env` со следующими переменными:
```
BOT_TOKEN=ваш_токен_бота_telegram
ADMIN_GROUP_ID=id_админ_группы
MAIN_TOPIC_ID=id_основного_топика
MAILING_TOPIC_ID=id_топика_рассылок
EVENTS_TOPIC_ID=id_топика_событий
AMOCRM_URL=url_вашего_amocrm
AMOCRM_ACCESS_TOKEN=токен_доступа_amocrm
AMOCRM_PIPELINE_ID=id_воронки
```

3. Запустите бота:
```bash
python main.py
```

## Цели проекта

Основная цель проекта — создать **надежную и гибкую структуру** для:
- Эффективной публикации контента
- Отслеживания действий и вовлеченности пользователей
- Управления автоматическими коммуникациями
- Интеграции с внешними CRM-системами

Архитектура подчеркивает чистоту кода, поддерживаемость и масштабируемость, сохраняя при этом минималистичность кодовой базы и фокус на основной функциональности.

